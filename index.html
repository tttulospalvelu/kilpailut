<script>
  const registryUrl = "YOUR_PUBLISHED_REGISTRY_SHEET_URL&output=csv";

  async function loadCompetitions() {
    const res = await fetch(registryUrl);
    const text = await res.text();
    const rows = text.trim().split("\n").map(r => r.split(","));
    const headers = rows.shift();
    const comps = rows.map(r => Object.fromEntries(r.map((v, i) => [headers[i].trim(), v])));

    console.log("Headers:", headers); // ✅ Debug
    console.log("First row parsed:", comps[0]); // ✅ Debug

    const listDiv = document.getElementById("competition-list");
    listDiv.innerHTML = ""; // reset

    comps.forEach(c => {
      const container = document.createElement("div");

      const link = document.createElement("a");
      link.href = "#";
      link.textContent = `${c.Competition} (${c.Status})`;
      link.onclick = () => showCompetition(c);

      // Show start date too
      const dateSpan = document.createElement("span");
      dateSpan.textContent = ` — ${c.StartDate}`;

      container.appendChild(link);
      container.appendChild(dateSpan);

      listDiv.appendChild(container);
    });
  }

  async function showCompetition(comp) {
    const viewDiv = document.getElementById("competition-view");
    viewDiv.innerHTML = `<h2>${comp.Competition}</h2>
                         <p>Status: ${comp.Status}</p>
                         <p>Start: ${comp.StartDate}</p>`;

    if (comp.SheetURL) {
      console.log("Loading sheet from:", comp.SheetURL); // ✅ Debug
      const resultsUrl = comp.SheetURL + "&output=csv"; 
      const res = await fetch(resultsUrl);
      const text = await res.text();
      const rows = text.trim().split("\n").map(r => r.split(","));
      const headers = rows.shift();

      const tableData = rows.map(r => Object.fromEntries(r.map((v, i) => [headers[i], v])));

      const tableEl = document.createElement("div");
      viewDiv.appendChild(tableEl);

      new Tabulator(tableEl, {
        data: tableData,
        autoColumns: true,
        layout: "fitColumns",
      });
    } else {
      viewDiv.innerHTML += `<p><em>No SheetURL provided for this competition.</em></p>`;
    }
  }

  loadCompetitions();
</script>
